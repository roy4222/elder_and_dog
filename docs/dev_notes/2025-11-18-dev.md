
# 2025-11-18 開發日誌

## 今日目標
- [x] 完成 `search_logic` 套件的程式碼審查與工程化強化
- [x] 驗證 ROS 2 環境與 Go2 導航堆疊啟動流程
- [x] 釐清後續將 `SimplePatrolNode` 擴充為完整搜尋 FSM 的發展路線

## 實際完成事項

### 1. `search_logic` 套件程式碼審查與改進

- 確認現有實作與「方案 A 完成報告」對齊  
  - 檔案與功能清單與報告一致（`nav2_client.py`、`simple_patrol_node.py`、`patrol_params.yaml`、`patrol.launch.py`、`test_import.py`、`package.xml`、`setup.py`、`README.md` 等）。  
  - 確認 `Nav2Client` 實作有完整封裝 `NavigateToPose`：支援 feedback、result callback 以及取消導航。  
  - 確認 `SimplePatrolNode` 僅包含 `IDLE` / `PATROL` 兩種狀態，支援固定巡邏點、循環巡邏、自動/手動啟動以及 `/patrol_command` / `/patrol_status` topic 控制。

- 改進 1：清理未使用的 Launch 參數  
  - 檔案：`src/search_logic/launch/patrol.launch.py`  
  - 移除未實際使用的 `use_params_file` 參數，只保留 `auto_start`、`loop_patrol`。  
  - 讓 Launch 檔參數與實際行為一致，減少日後混淆。

- 改進 2：強化 Nav2 未啟動時的錯誤處理  
  - 檔案：`src/search_logic/search_logic/simple_patrol_node.py`  
  - 原本行為：`wait_for_server()` 失敗時僅 log error 然後 `return`，節點可能處於「假活著」狀態。  
  - 新行為：  
    - log error + `get_logger().fatal('節點無法繼續運行，即將退出')`  
    - 直接 `raise RuntimeError('Nav2 服務未啟動，無法初始化巡邏節點')`  
  - 好處：啟動失敗可立即被使用者或上層監控發現，不會誤以為節點已正常運行。

- 改進 3：將 `test_import.py` 改為 pytest 自動化測試  
  - 檔案：`src/search_logic/test/test_import.py`  
  - 由原本的「手動自檢腳本（只有 print、沒有 assert）」重構為標準 pytest 測試：  
    - `test_rclpy_imports()`：測試 ROS2 核心 imports（`rclpy`、`Node`、`ActionClient`）。  
    - `test_message_imports()`：測試 `geometry_msgs`、`nav2_msgs`、`std_msgs` imports。  
    - `test_search_logic_imports()`：測試 `search_logic.nav2_client`、`search_logic.simple_patrol_node` imports。  
    - `test_nav2_client_class()`：確認 `Nav2Client` 具備 `wait_for_server`、`send_goal`、`cancel_goal` 等必要方法。  
    - `test_patrol_state_enum()`：確認 `PatrolState` 枚舉定義與數值（IDLE=0, PATROL=1）。  
    - `test_simple_patrol_node_class()`：確認 `SimplePatrolNode` 具備核心方法（`command_callback`、`state_machine_update`、`handle_patrol`、`nav_result_callback`）。  
  - 支援執行方式：  
    - `colcon test --packages-select search_logic`  
    - 或直接：`python3 src/search_logic/test/test_import.py`

- 改進 4：補齊 `package.xml` 依賴宣告  
  - 檔案：`src/search_logic/package.xml`  
  - 新增 Launch 相關執行時依賴：  
    - `<exec_depend>launch</exec_depend>`  
    - `<exec_depend>launch_ros</exec_depend>`  
    - `<exec_depend>ament_index_python</exec_depend>`  
  - 目的：確保 `search_logic` 在獨立 workspace 中也能正確解析 Launch 檔所需的依賴，符合 ROS2 套件標準。

- 改進 5：更新 README 文件，澄清啟動方式與測試說明  
  - 檔案：`src/search_logic/README.md`  
  - 新增說明：明確註記「本套件提供單一節點 `simple_patrol_node`，以下是三種不同的操作模式（非三個不同節點）」，避免讀者誤解。  
  - 新增「🧪 自動化測試」章節：  
    - 說明如何透過 `colcon test` 與 `pytest` 執行測試。  
    - 列出 6 個測試項目與預期輸出範例（全部 PASSED）。  
  - 補齊錯誤排查、效能指標、未來擴充（Search FSM）等說明，使文件更工程化。

- 新增改進說明文件  
  - 檔案：`src/search_logic/IMPROVEMENTS.md`  
  - 紀錄 5 項改進的背景、具體修改內容、前後對比與完成度評估。  
  - 幫助未來維護者快速理解：從「教學用範例」演進到「可進 CI 的工程級導航測試套件」的過程。

### 2. ROS2 / Go2 導航堆疊啟動與問題分析

- 成功編譯 `search_logic` 套件  
  - 指令：`colcon build --packages-select search_logic` 正常完成，代表套件的 Python 與 ROS2 設定無問題。

- 啟動 Go2 + Nav2 + SLAM + RViz  
  - 指令：`ros2 launch go2_robot_sdk robot.launch.py slam:=true nav2:=true rviz2:=true`  
  - 觀察結果：  
    - Nav2 / SLAM 堆疊（`controller_server`、`planner_server`、`behavior_server`、`bt_navigator` 等）皆成功啟動並被 `lifecycle_manager_navigation` 啟用為 active 狀態。  
    - 代表導航核心本身是健康的，可以支援後續的巡邏與路徑規劃。

- 發現的實際錯誤（與 search_logic 無關，但會影響整體系統）  
  - `go2_driver_node` 錯誤：  
    - log：`aioice submodule is not initalized. please init submodules recursively`  
    - 判斷：需要執行 `git submodule update --init --recursive` 以初始化 aioice 等子模組，否則 driver 無法正常運行。  
  - `tts_node`（speech_processor）錯誤：  
    - log：`ModuleNotFoundError: No module named 'pydub'`  
    - 判斷：在 `.venv` 中缺少 `pydub`，需透過 `pip install pydub` 安裝並重建 `speech_processor`。  
  - `lidar_to_pointcloud`（lidar_processor）錯誤：  
    - log：`ModuleNotFoundError: No module named 'open3d'`  
    - 判斷：同樣是 Python 依賴缺失，需在 `.venv` 中安裝 `open3d`，再重建 `lidar_processor`。

- 環境啟動順序建議  
  - 新開 Terminal 的建議順序：  
    ```bash
    cd ~/ros2_ws
    source /opt/ros/humble/setup.bash
    source .venv/bin/activate
    source install/setup.bash
    ```  
  - 先 ROS、後虛擬環境、最後 workspace 的 install，避免 PATH 與 Python module path 打架。

- 與 Claude 建議方案的對齊  
  - 雙方一致判斷：  
    - 問題主因在於「submodule 未初始化 + Python 依賴未安裝」，非 `ROBOT_IP` 或 ROS graph。  
  - 差異在操作策略：  
    - Claude 偏向「刪除 build/install/log、跑 rosdep、全域重裝 requirements、完整重建 workspace」。  
    - 目前採用策略偏向「精準修補」：先初始化 submodule + 補齊 `aioice/pydub/open3d` 相關依賴 + 局部重編相關 packages，如有異常再考慮全面重建。

## 明日計畫（2025-11-19）

### 1. 修復依賴與子模組（優先）

- [x] 在專案根目錄執行 `git submodule update --init --recursive`，aioice 已完成初始化。  
- [x] 在 ROS2 虛擬環境中補齊 Python 依賴（`pydub`、`open3d` 等）並安裝。  
- [x] 局部重建相關套件：`colcon build --packages-select go2_robot_sdk speech_processor lidar_processor`（實際 7 套件皆已編譯成功）。

### 2. 驗證簡化啟動與完整導航堆疊

- [x] 簡化模式驗證（只測 driver 與基礎運作）：  
  - `ros2 launch go2_robot_sdk robot.launch.py slam:=false nav2:=false`  
- [ ] 完整導航模式驗證：  
  - `ros2 launch go2_robot_sdk robot.launch.py slam:=true nav2:=true rviz2:=true`  
  - 檢查：  
    - SLAM / Nav2 是否能順利 active。  
    - RViz 是否可以看到地圖與機器人姿態。  
    - 不再出現 `pydub` / `open3d` 的 ModuleNotFoundError（目前尚需處理 NumPy/SciPy 相容性與 ffmpeg/TTS API key）。

### 3. 方案 A 巡邏節點實機/模擬驗收

- Terminal 1：啟動 Go2 + Nav2（同 README / QUICKSTART_NAVIGATION）。  
- Terminal 2：啟動巡邏節點：  
  - 推薦：`ros2 launch search_logic patrol.launch.py auto_start:=true`  
  - 或：`ros2 run search_logic simple_patrol_node` 搭配 `/patrol_command` 手動控制（start/stop/reset）。  
- 驗證項目：  
  - 能否成功訪問 `patrol_params.yaml` 中設定的多個巡邏點。  
  - `loop_patrol` 為 `true` 時是否可重複巡邏。  
  - `/patrol_status` topic 是否持續更新狀態。  
  - RViz 中可否清楚看到路徑與目標點。

### 3. WebRTC 連接故障診斷與根本原因確認（重要進展）

**問題描述**：
- go2_driver_node 啟動時視訊串流正常（"Video frame received"），但無法控制機器人
- TEST.sh 的 sit/stand/forward 等指令發送成功，但機器人無反應
- 根本原因：**WebRTC 數據通道卡在 "connecting" 狀態，無法打開**

**診斷過程**：

1. **環境清理**
   - 清理 `/tmp/fastrtps_*`、`/dev/shm/rtps_*`、`~/.ros/log/*`
   - 殺死孤立的 go2_driver_node 進程（PID: 59160、59636、60478、67256）
   - 重啟 ROS2 daemon

2. **CycloneDDS 測試結果**
   - 驅動以 `Connection mode: multi` 啟動（預期多機器人或以太網直連）
   - 無 WebRTC 相關錯誤（因為不使用 WebRTC）
   - 但仍無法控制（CycloneDDS 不適用於 Wi-Fi 單一連接）

3. **WebRTC 日誌詳細分析**
   - 驅動日誌只顯示 2 行關鍵訊息：
     ```
     WARNING:go2_robot_sdk.infrastructure.webrtc.go2_connection:Data channel is not open. State is connecting
     INFO:go2_robot_sdk.presentation.go2_driver_node:Video frame received for robot 0
     ```
   - **關鍵發現**：代碼應該輸出 `"Data channel is open"` 的 INFO 訊息（[go2_connection.py:94](go2_robot_sdk/go2_robot_sdk/infrastructure/webrtc/go2_connection.py#L94)），但該訊息從未出現

4. **根本原因確認**
   - 事件 `on_data_channel_open` 從未被 aiortc 觸發
   - 這表示 DTLS 握手失敗（ICE 連線建立，但 DTLS 握手超時或失敗）

**根本原因分析**：

| 原因 | 機率 | 證據 |
|------|------|------|
| **DTLS 握手失敗（主要）** | ⭐⭐⭐⭐⭐ | 視訊成功（SDP 交換OK），但 DTLS 握手包在 WSL2 NAT 中遺失 |
| **ICE 連線無效** | ⭐⭐⭐⭐ | aiortc 無可用的 ICE 候選項，airortc 預設無 STUN 伺服器配置 |
| **Go2 韌體版本不兼容** | ⭐⭐⭐ | 機器人端可能限制特定 DTLS 配置或 WebRTC 版本 |

**已嘗試的修復方案及結果**：
- ✅ 清理環境 → 無改善
- ✅ 添加 STUN 伺服器配置（RTCConfiguration + Google STUN）→ 無改善
  - 修改檔案：[go2_connection.py:46-53](go2_robot_sdk/go2_robot_sdk/infrastructure/webrtc/go2_connection.py#L46-L53)
  - 重新編譯：`colcon build --packages-select go2_robot_sdk`
  - 結果：DTLS 握手仍失敗

**建議的後續行動**（優先順序）**：

1. **檢查 Go2 韌體版本**（推薦度 ⭐⭐⭐⭐⭐）
   - 透過手機 App / Web 界面查詢機器人韌體版本
   - 檢查 RoboVerse 項目中是否有已知的 WSL2 相容性問題

2. **檢查自訂 aioice 子模組**（⭐⭐⭐⭐）
   - 路徑：`go2_robot_sdk/external_lib/aioice@go2`
   - 查看是否有 WSL2/NAT 相關的修補程式
   - 查看提交歷史：`cd go2_robot_sdk/external_lib/aioice && git log --oneline | head -10`

3. **在原生 Linux 環境測試**（⭐⭐⭐）
   - 在非 WSL2 的 Ubuntu 虛擬機上測試同一驅動
   - 若成功，問題確認為 WSL2 相關

4. **啟用詳細的 aiortc 日誌**（⭐⭐⭐）
   - 修改 go2_connection.py 以輸出 aiortc 的 DEBUG 級別日誌
   - 可能會看到具體的 ICE/DTLS 錯誤訊息

5. **考慮備用方案**（⭐⭐）
   - 直接使用 Go2 HTTP API 而非 WebRTC
   - 或等待 RoboVerse 上游修復

### 4. 若仍有環境異常：考慮進行 workspace 大掃除（可選）

- 若上述精準修補後仍有難以追蹤的錯誤，可採用較激進方案：
  ```bash
  cd ~/ros2_ws
  rm -rf build/ install/ log/
  rosdep install --from-paths src --ignore-src -r -y
  colcon build --symlink-install
  ```
- 再依照標準流程 source 與啟動，確保整個 workspace 乾淨一致。

### 5. 規劃從巡邏節點走向搜尋 FSM

- 在 `docs/search_fsm_design.md` 的基礎上，開始規劃：
  - 如何從 `SimplePatrolNode` 重構/擴充為 `SearchFSMNode`：
    - 新增狀態：SCANNING / NAVIGATING_TO_OBJECT / APPROACHING / SUCCESS / FAILED。
    - 新增訂閱：`/detected_objects`（VLM 結果）、`/object_pose_world`（座標轉換結果）。
  - 探討哪些邏輯可以直接重用既有 `nav2_client.py` 與巡邏邏輯，哪些需要抽象為共用元件。
- 目標：在方案 A 穩定的前提下，自然地過渡到 W6–W9 規劃中的完整尋物系統。
