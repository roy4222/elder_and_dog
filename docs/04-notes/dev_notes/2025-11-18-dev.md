
# 2025-11-18 é–‹ç™¼æ—¥èªŒ

## ä»Šæ—¥ç›®æ¨™
- [x] å®Œæˆ `search_logic` å¥—ä»¶çš„ç¨‹å¼ç¢¼å¯©æŸ¥èˆ‡å·¥ç¨‹åŒ–å¼·åŒ–
- [x] é©—è­‰ ROS 2 ç’°å¢ƒèˆ‡ Go2 å°èˆªå †ç–Šå•Ÿå‹•æµç¨‹
- [x] é‡æ¸…å¾ŒçºŒå°‡ `SimplePatrolNode` æ“´å……ç‚ºå®Œæ•´æœå°‹ FSM çš„ç™¼å±•è·¯ç·š

## å¯¦éš›å®Œæˆäº‹é …

### 1. `search_logic` å¥—ä»¶ç¨‹å¼ç¢¼å¯©æŸ¥èˆ‡æ”¹é€²

- ç¢ºèªç¾æœ‰å¯¦ä½œèˆ‡ã€Œæ–¹æ¡ˆ A å®Œæˆå ±å‘Šã€å°é½Š  
  - æª”æ¡ˆèˆ‡åŠŸèƒ½æ¸…å–®èˆ‡å ±å‘Šä¸€è‡´ï¼ˆ`nav2_client.py`ã€`simple_patrol_node.py`ã€`patrol_params.yaml`ã€`patrol.launch.py`ã€`test_import.py`ã€`package.xml`ã€`setup.py`ã€`README.md` ç­‰ï¼‰ã€‚  
  - ç¢ºèª `Nav2Client` å¯¦ä½œæœ‰å®Œæ•´å°è£ `NavigateToPose`ï¼šæ”¯æ´ feedbackã€result callback ä»¥åŠå–æ¶ˆå°èˆªã€‚  
  - ç¢ºèª `SimplePatrolNode` åƒ…åŒ…å« `IDLE` / `PATROL` å…©ç¨®ç‹€æ…‹ï¼Œæ”¯æ´å›ºå®šå·¡é‚é»ã€å¾ªç’°å·¡é‚ã€è‡ªå‹•/æ‰‹å‹•å•Ÿå‹•ä»¥åŠ `/patrol_command` / `/patrol_status` topic æ§åˆ¶ã€‚

- æ”¹é€² 1ï¼šæ¸…ç†æœªä½¿ç”¨çš„ Launch åƒæ•¸  
  - æª”æ¡ˆï¼š`src/search_logic/launch/patrol.launch.py`  
  - ç§»é™¤æœªå¯¦éš›ä½¿ç”¨çš„ `use_params_file` åƒæ•¸ï¼Œåªä¿ç•™ `auto_start`ã€`loop_patrol`ã€‚  
  - è®“ Launch æª”åƒæ•¸èˆ‡å¯¦éš›è¡Œç‚ºä¸€è‡´ï¼Œæ¸›å°‘æ—¥å¾Œæ··æ·†ã€‚

- æ”¹é€² 2ï¼šå¼·åŒ– Nav2 æœªå•Ÿå‹•æ™‚çš„éŒ¯èª¤è™•ç†  
  - æª”æ¡ˆï¼š`src/search_logic/search_logic/simple_patrol_node.py`  
  - åŸæœ¬è¡Œç‚ºï¼š`wait_for_server()` å¤±æ•—æ™‚åƒ… log error ç„¶å¾Œ `return`ï¼Œç¯€é»å¯èƒ½è™•æ–¼ã€Œå‡æ´»è‘—ã€ç‹€æ…‹ã€‚  
  - æ–°è¡Œç‚ºï¼š  
    - log error + `get_logger().fatal('ç¯€é»ç„¡æ³•ç¹¼çºŒé‹è¡Œï¼Œå³å°‡é€€å‡º')`  
    - ç›´æ¥ `raise RuntimeError('Nav2 æœå‹™æœªå•Ÿå‹•ï¼Œç„¡æ³•åˆå§‹åŒ–å·¡é‚ç¯€é»')`  
  - å¥½è™•ï¼šå•Ÿå‹•å¤±æ•—å¯ç«‹å³è¢«ä½¿ç”¨è€…æˆ–ä¸Šå±¤ç›£æ§ç™¼ç¾ï¼Œä¸æœƒèª¤ä»¥ç‚ºç¯€é»å·²æ­£å¸¸é‹è¡Œã€‚

- æ”¹é€² 3ï¼šå°‡ `test_import.py` æ”¹ç‚º pytest è‡ªå‹•åŒ–æ¸¬è©¦  
  - æª”æ¡ˆï¼š`src/search_logic/test/test_import.py`  
  - ç”±åŸæœ¬çš„ã€Œæ‰‹å‹•è‡ªæª¢è…³æœ¬ï¼ˆåªæœ‰ printã€æ²’æœ‰ assertï¼‰ã€é‡æ§‹ç‚ºæ¨™æº– pytest æ¸¬è©¦ï¼š  
    - `test_rclpy_imports()`ï¼šæ¸¬è©¦ ROS2 æ ¸å¿ƒ importsï¼ˆ`rclpy`ã€`Node`ã€`ActionClient`ï¼‰ã€‚  
    - `test_message_imports()`ï¼šæ¸¬è©¦ `geometry_msgs`ã€`nav2_msgs`ã€`std_msgs` importsã€‚  
    - `test_search_logic_imports()`ï¼šæ¸¬è©¦ `search_logic.nav2_client`ã€`search_logic.simple_patrol_node` importsã€‚  
    - `test_nav2_client_class()`ï¼šç¢ºèª `Nav2Client` å…·å‚™ `wait_for_server`ã€`send_goal`ã€`cancel_goal` ç­‰å¿…è¦æ–¹æ³•ã€‚  
    - `test_patrol_state_enum()`ï¼šç¢ºèª `PatrolState` æšèˆ‰å®šç¾©èˆ‡æ•¸å€¼ï¼ˆIDLE=0, PATROL=1ï¼‰ã€‚  
    - `test_simple_patrol_node_class()`ï¼šç¢ºèª `SimplePatrolNode` å…·å‚™æ ¸å¿ƒæ–¹æ³•ï¼ˆ`command_callback`ã€`state_machine_update`ã€`handle_patrol`ã€`nav_result_callback`ï¼‰ã€‚  
  - æ”¯æ´åŸ·è¡Œæ–¹å¼ï¼š  
    - `colcon test --packages-select search_logic`  
    - æˆ–ç›´æ¥ï¼š`python3 src/search_logic/test/test_import.py`

- æ”¹é€² 4ï¼šè£œé½Š `package.xml` ä¾è³´å®£å‘Š  
  - æª”æ¡ˆï¼š`src/search_logic/package.xml`  
  - æ–°å¢ Launch ç›¸é—œåŸ·è¡Œæ™‚ä¾è³´ï¼š  
    - `<exec_depend>launch</exec_depend>`  
    - `<exec_depend>launch_ros</exec_depend>`  
    - `<exec_depend>ament_index_python</exec_depend>`  
  - ç›®çš„ï¼šç¢ºä¿ `search_logic` åœ¨ç¨ç«‹ workspace ä¸­ä¹Ÿèƒ½æ­£ç¢ºè§£æ Launch æª”æ‰€éœ€çš„ä¾è³´ï¼Œç¬¦åˆ ROS2 å¥—ä»¶æ¨™æº–ã€‚

- æ”¹é€² 5ï¼šæ›´æ–° README æ–‡ä»¶ï¼Œæ¾„æ¸…å•Ÿå‹•æ–¹å¼èˆ‡æ¸¬è©¦èªªæ˜  
  - æª”æ¡ˆï¼š`src/search_logic/README.md`  
  - æ–°å¢èªªæ˜ï¼šæ˜ç¢ºè¨»è¨˜ã€Œæœ¬å¥—ä»¶æä¾›å–®ä¸€ç¯€é» `simple_patrol_node`ï¼Œä»¥ä¸‹æ˜¯ä¸‰ç¨®ä¸åŒçš„æ“ä½œæ¨¡å¼ï¼ˆéä¸‰å€‹ä¸åŒç¯€é»ï¼‰ã€ï¼Œé¿å…è®€è€…èª¤è§£ã€‚  
  - æ–°å¢ã€ŒğŸ§ª è‡ªå‹•åŒ–æ¸¬è©¦ã€ç« ç¯€ï¼š  
    - èªªæ˜å¦‚ä½•é€é `colcon test` èˆ‡ `pytest` åŸ·è¡Œæ¸¬è©¦ã€‚  
    - åˆ—å‡º 6 å€‹æ¸¬è©¦é …ç›®èˆ‡é æœŸè¼¸å‡ºç¯„ä¾‹ï¼ˆå…¨éƒ¨ PASSEDï¼‰ã€‚  
  - è£œé½ŠéŒ¯èª¤æ’æŸ¥ã€æ•ˆèƒ½æŒ‡æ¨™ã€æœªä¾†æ“´å……ï¼ˆSearch FSMï¼‰ç­‰èªªæ˜ï¼Œä½¿æ–‡ä»¶æ›´å·¥ç¨‹åŒ–ã€‚

- æ–°å¢æ”¹é€²èªªæ˜æ–‡ä»¶  
  - æª”æ¡ˆï¼š`src/search_logic/IMPROVEMENTS.md`  
  - ç´€éŒ„ 5 é …æ”¹é€²çš„èƒŒæ™¯ã€å…·é«”ä¿®æ”¹å…§å®¹ã€å‰å¾Œå°æ¯”èˆ‡å®Œæˆåº¦è©•ä¼°ã€‚  
  - å¹«åŠ©æœªä¾†ç¶­è­·è€…å¿«é€Ÿç†è§£ï¼šå¾ã€Œæ•™å­¸ç”¨ç¯„ä¾‹ã€æ¼”é€²åˆ°ã€Œå¯é€² CI çš„å·¥ç¨‹ç´šå°èˆªæ¸¬è©¦å¥—ä»¶ã€çš„éç¨‹ã€‚

### 2. ROS2 / Go2 å°èˆªå †ç–Šå•Ÿå‹•èˆ‡å•é¡Œåˆ†æ

- æˆåŠŸç·¨è­¯ `search_logic` å¥—ä»¶  
  - æŒ‡ä»¤ï¼š`colcon build --packages-select search_logic` æ­£å¸¸å®Œæˆï¼Œä»£è¡¨å¥—ä»¶çš„ Python èˆ‡ ROS2 è¨­å®šç„¡å•é¡Œã€‚

- å•Ÿå‹• Go2 + Nav2 + SLAM + RViz  
  - æŒ‡ä»¤ï¼š`ros2 launch go2_robot_sdk robot.launch.py slam:=true nav2:=true rviz2:=true`  
  - è§€å¯Ÿçµæœï¼š  
    - Nav2 / SLAM å †ç–Šï¼ˆ`controller_server`ã€`planner_server`ã€`behavior_server`ã€`bt_navigator` ç­‰ï¼‰çš†æˆåŠŸå•Ÿå‹•ä¸¦è¢« `lifecycle_manager_navigation` å•Ÿç”¨ç‚º active ç‹€æ…‹ã€‚  
    - ä»£è¡¨å°èˆªæ ¸å¿ƒæœ¬èº«æ˜¯å¥åº·çš„ï¼Œå¯ä»¥æ”¯æ´å¾ŒçºŒçš„å·¡é‚èˆ‡è·¯å¾‘è¦åŠƒã€‚

- ç™¼ç¾çš„å¯¦éš›éŒ¯èª¤ï¼ˆèˆ‡ search_logic ç„¡é—œï¼Œä½†æœƒå½±éŸ¿æ•´é«”ç³»çµ±ï¼‰  
  - `go2_driver_node` éŒ¯èª¤ï¼š  
    - logï¼š`aioice submodule is not initalized. please init submodules recursively`  
    - åˆ¤æ–·ï¼šéœ€è¦åŸ·è¡Œ `git submodule update --init --recursive` ä»¥åˆå§‹åŒ– aioice ç­‰å­æ¨¡çµ„ï¼Œå¦å‰‡ driver ç„¡æ³•æ­£å¸¸é‹è¡Œã€‚  
  - `tts_node`ï¼ˆspeech_processorï¼‰éŒ¯èª¤ï¼š  
    - logï¼š`ModuleNotFoundError: No module named 'pydub'`  
    - åˆ¤æ–·ï¼šåœ¨ `.venv` ä¸­ç¼ºå°‘ `pydub`ï¼Œéœ€é€é `pip install pydub` å®‰è£ä¸¦é‡å»º `speech_processor`ã€‚  
  - `lidar_to_pointcloud`ï¼ˆlidar_processorï¼‰éŒ¯èª¤ï¼š  
    - logï¼š`ModuleNotFoundError: No module named 'open3d'`  
    - åˆ¤æ–·ï¼šåŒæ¨£æ˜¯ Python ä¾è³´ç¼ºå¤±ï¼Œéœ€åœ¨ `.venv` ä¸­å®‰è£ `open3d`ï¼Œå†é‡å»º `lidar_processor`ã€‚

- ç’°å¢ƒå•Ÿå‹•é †åºå»ºè­°  
  - æ–°é–‹ Terminal çš„å»ºè­°é †åºï¼š  
    ```bash
    cd ~/ros2_ws
    source /opt/ros/humble/setup.bash
    source .venv/bin/activate
    source install/setup.bash
    ```  
  - å…ˆ ROSã€å¾Œè™›æ“¬ç’°å¢ƒã€æœ€å¾Œ workspace çš„ installï¼Œé¿å… PATH èˆ‡ Python module path æ‰“æ¶ã€‚

- èˆ‡ Claude å»ºè­°æ–¹æ¡ˆçš„å°é½Š  
  - é›™æ–¹ä¸€è‡´åˆ¤æ–·ï¼š  
    - å•é¡Œä¸»å› åœ¨æ–¼ã€Œsubmodule æœªåˆå§‹åŒ– + Python ä¾è³´æœªå®‰è£ã€ï¼Œé `ROBOT_IP` æˆ– ROS graphã€‚  
  - å·®ç•°åœ¨æ“ä½œç­–ç•¥ï¼š  
    - Claude åå‘ã€Œåˆªé™¤ build/install/logã€è·‘ rosdepã€å…¨åŸŸé‡è£ requirementsã€å®Œæ•´é‡å»º workspaceã€ã€‚  
    - ç›®å‰æ¡ç”¨ç­–ç•¥åå‘ã€Œç²¾æº–ä¿®è£œã€ï¼šå…ˆåˆå§‹åŒ– submodule + è£œé½Š `aioice/pydub/open3d` ç›¸é—œä¾è³´ + å±€éƒ¨é‡ç·¨ç›¸é—œ packagesï¼Œå¦‚æœ‰ç•°å¸¸å†è€ƒæ…®å…¨é¢é‡å»ºã€‚

## æ˜æ—¥è¨ˆç•«ï¼ˆ2025-11-19ï¼‰

### 1. ä¿®å¾©ä¾è³´èˆ‡å­æ¨¡çµ„ï¼ˆå„ªå…ˆï¼‰

- [x] åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„åŸ·è¡Œ `git submodule update --init --recursive`ï¼Œaioice å·²å®Œæˆåˆå§‹åŒ–ã€‚  
- [x] åœ¨ ROS2 è™›æ“¬ç’°å¢ƒä¸­è£œé½Š Python ä¾è³´ï¼ˆ`pydub`ã€`open3d` ç­‰ï¼‰ä¸¦å®‰è£ã€‚  
- [x] å±€éƒ¨é‡å»ºç›¸é—œå¥—ä»¶ï¼š`colcon build --packages-select go2_robot_sdk speech_processor lidar_processor`ï¼ˆå¯¦éš› 7 å¥—ä»¶çš†å·²ç·¨è­¯æˆåŠŸï¼‰ã€‚

### 2. é©—è­‰ç°¡åŒ–å•Ÿå‹•èˆ‡å®Œæ•´å°èˆªå †ç–Š

- [x] ç°¡åŒ–æ¨¡å¼é©—è­‰ï¼ˆåªæ¸¬ driver èˆ‡åŸºç¤é‹ä½œï¼‰ï¼š  
  - `ros2 launch go2_robot_sdk robot.launch.py slam:=false nav2:=false`  
- [ ] å®Œæ•´å°èˆªæ¨¡å¼é©—è­‰ï¼š  
  - `ros2 launch go2_robot_sdk robot.launch.py slam:=true nav2:=true rviz2:=true`  
  - æª¢æŸ¥ï¼š  
    - SLAM / Nav2 æ˜¯å¦èƒ½é †åˆ© activeã€‚  
    - RViz æ˜¯å¦å¯ä»¥çœ‹åˆ°åœ°åœ–èˆ‡æ©Ÿå™¨äººå§¿æ…‹ã€‚  
    - ä¸å†å‡ºç¾ `pydub` / `open3d` çš„ ModuleNotFoundErrorï¼ˆç›®å‰å°šéœ€è™•ç† NumPy/SciPy ç›¸å®¹æ€§èˆ‡ ffmpeg/TTS API keyï¼‰ã€‚

### 3. æ–¹æ¡ˆ A å·¡é‚ç¯€é»å¯¦æ©Ÿ/æ¨¡æ“¬é©—æ”¶

- Terminal 1ï¼šå•Ÿå‹• Go2 + Nav2ï¼ˆåŒ README / QUICKSTART_NAVIGATIONï¼‰ã€‚  
- Terminal 2ï¼šå•Ÿå‹•å·¡é‚ç¯€é»ï¼š  
  - æ¨è–¦ï¼š`ros2 launch search_logic patrol.launch.py auto_start:=true`  
  - æˆ–ï¼š`ros2 run search_logic simple_patrol_node` æ­é… `/patrol_command` æ‰‹å‹•æ§åˆ¶ï¼ˆstart/stop/resetï¼‰ã€‚  
- é©—è­‰é …ç›®ï¼š  
  - èƒ½å¦æˆåŠŸè¨ªå• `patrol_params.yaml` ä¸­è¨­å®šçš„å¤šå€‹å·¡é‚é»ã€‚  
  - `loop_patrol` ç‚º `true` æ™‚æ˜¯å¦å¯é‡è¤‡å·¡é‚ã€‚  
  - `/patrol_status` topic æ˜¯å¦æŒçºŒæ›´æ–°ç‹€æ…‹ã€‚  
  - RViz ä¸­å¯å¦æ¸…æ¥šçœ‹åˆ°è·¯å¾‘èˆ‡ç›®æ¨™é»ã€‚

### 3. WebRTC é€£æ¥æ•…éšœè¨ºæ–·èˆ‡æ ¹æœ¬åŸå› æ¨è«–ï¼ˆé‡è¦é€²å±•ï¼‰

**å•é¡Œæè¿°**ï¼š
- go2_driver_node å•Ÿå‹•æ™‚è¦–è¨Šä¸²æµæ­£å¸¸ï¼ˆ"Video frame received"ï¼‰ï¼Œbut WebRTC data channel åœç•™åœ¨ connecting ç‹€æ…‹
- TEST.sh çš„ sit/stand/forward ç­‰æŒ‡ä»¤ç¶“ç”± `/webrtc_req` ç™¼å‡ºï¼Œä½†æ©Ÿå™¨äººç„¡åæ‡‰
- **è§€å¯Ÿç¾è±¡**ï¼šon_data_channel_open() å¾æœªè¢«è§¸ç™¼ï¼Œå°è‡´ data channel ç„¡æ³•å»ºç«‹é€šè¨Š

**è¨ºæ–·éç¨‹**ï¼š

1. **ç’°å¢ƒæ¸…ç†**
   - æ¸…ç† `/tmp/fastrtps_*`ã€`/dev/shm/rtps_*`ã€`~/.ros/log/*`
   - æ®ºæ­»å­¤ç«‹çš„ go2_driver_node é€²ç¨‹ï¼ˆPID: 59160ã€59636ã€60478ã€67256ï¼‰
   - é‡å•Ÿ ROS2 daemon

2. **CycloneDDS æ¸¬è©¦çµæœ**
   - é©…å‹•ä»¥ `Connection mode: multi` å•Ÿå‹•ï¼ˆéé æœŸçš„å¤šæ©Ÿå™¨äººæ¨¡å¼ï¼‰
   - CycloneDDS å•Ÿå‹•ç„¡ WebRTC ç›¸é—œéŒ¯èª¤ï¼Œä½†å°šæœªé©—è­‰èƒ½ç©©å®šæ§åˆ¶æ©Ÿå™¨äºº

3. **WebRTC æ¡æ‰‹å®Œæ•´åˆ†æ**
   - å•Ÿç”¨ DEBUG ç´šåˆ¥æ—¥èªŒï¼Œæ·»åŠ  ICE/DTLS/SCTP äº‹ä»¶ç›£è½
   - è¿½è¹¤æ¡æ‰‹å››éšæ®µï¼š
     - âœ… **Phase 1: SDP äº¤æ›** â†’ HTTP åŠ å¯†é€šé“æˆåŠŸï¼Œæ©Ÿå™¨äººæ”¶åˆ° Offer ä¸¦å›æ‡‰ Answer
     - âœ… **Phase 2: ICE é€£æ¥** â†’ Candidates äº¤æ›æˆåŠŸï¼Œconnection state: completedï¼ŒUDP è·¯å¾‘å¯ç”¨
     - âœ… **Phase 3: DTLS æ¡æ‰‹** â†’ Connection state: connectedï¼ŒSRTP_AES128_CM_SHA1_80 å”å•†æˆåŠŸ
     - âŒ **Phase 4: SCTP æ¡æ‰‹** â†’ RTCSctpTransport ç™¼é€ InitChunkï¼Œæ©Ÿå™¨äººæœªå›æ‡‰

4. **SCTP æ¡æ‰‹å¤±æ•—çš„è§€å¯Ÿ**
   - aiortc ç™¼é€ `InitChunk(flags=0)` çµ¦æ©Ÿå™¨äºº
   - T1 è¶…æ™‚æ©Ÿåˆ¶ä¾æ¬¡è§¸ç™¼ï¼šexpired 1, 2, 3, 4, 5, 6, 7, 8, 9
   - æ©Ÿå™¨äººç«¯ç„¡å›æ‡‰ï¼ˆæœªè¿”å› InitChunk_ACKï¼‰
   - 30 ç§’å¾Œè¶…æ™‚ï¼ŒData channel çµ‚æ­¢ (State: closed)
   - æ¨è«–ï¼šæ¡æ‰‹å¡åœ¨ SCTP å”è­°å±¤ï¼Œè€Œé ICE/DTLS å±¤

3. **WebRTC æ—¥èªŒè©³ç´°åˆ†æ**
   - é©…å‹•æ—¥èªŒåªé¡¯ç¤º 2 è¡Œé—œéµè¨Šæ¯ï¼š
     ```
     WARNING:go2_robot_sdk.infrastructure.webrtc.go2_connection:Data channel is not open. State is connecting
     INFO:go2_robot_sdk.presentation.go2_driver_node:Video frame received for robot 0
     ```
   - **é—œéµç™¼ç¾**ï¼šä»£ç¢¼æ‡‰è©²è¼¸å‡º `"Data channel is open"` çš„ INFO è¨Šæ¯ï¼ˆ[go2_connection.py:94](go2_robot_sdk/go2_robot_sdk/infrastructure/webrtc/go2_connection.py#L94)ï¼‰ï¼Œä½†è©²è¨Šæ¯å¾æœªå‡ºç¾

4. **æ ¹æœ¬åŸå› ç¢ºèª**
   - äº‹ä»¶ `on_data_channel_open` å¾æœªè¢« aiortc è§¸ç™¼
   - é€™è¡¨ç¤º DTLS æ¡æ‰‹å¤±æ•—ï¼ˆICE é€£ç·šå»ºç«‹ï¼Œä½† DTLS æ¡æ‰‹è¶…æ™‚æˆ–å¤±æ•—ï¼‰

**æ ¹æœ¬åŸå› ç¢ºèªï¼ˆè©³ç´°æ¡æ‰‹åˆ†æï¼‰**ï¼š

å®Œæ•´æ¡æ‰‹æµç¨‹ï¼ˆä¾†è‡ª aiortc æ—¥èªŒï¼‰ï¼š

```
1ï¸âƒ£  ICE é€£ç·šï¼šâœ… COMPLETED
    [aioice.ice - INFO] Connection(1) Check CandidatePair(...) State.FROZEN -> State.IN_PROGRESS
    [aioice.ice - INFO] Connection(1) ICE completed
    [aiortc.rtcpeerconnection - DEBUG] iceConnectionState: new -> checking -> completed

2ï¸âƒ£  DTLS æ¡æ‰‹ï¼šâœ… CONNECTED
    [aiortc.rtcdtlstransport - DEBUG] State.NEW -> State.CONNECTING
    [aiortc.rtcdtlstransport - DEBUG] DTLS handshake negotiated SRTP_AES128_CM_SHA1_80
    [aiortc.rtcdtlstransport - DEBUG] DTLS handshake complete
    [aiortc.rtcdtlstransport - DEBUG] State.CONNECTING -> State.CONNECTED

3ï¸âƒ£  SCTP æ¡æ‰‹ï¼šâŒ FAILED (InitChunk timeout)
    [aiortc.rtcsctptransport - DEBUG] > InitChunk(flags=0)
    [aiortc.rtcsctptransport - DEBUG] - State.CLOSED -> State.COOKIE_WAIT
    [aiortc.rtcsctptransport - DEBUG] x T1(InitChunk) expired 1
    [aiortc.rtcsctptransport - DEBUG] x T1(InitChunk) expired 2
    [aiortc.rtcsctptransport - DEBUG] x T1(InitChunk) expired 3
    [aiortc.rtcsctptransport - DEBUG] x T1(InitChunk) expired 4
    âŒ æ©Ÿå™¨äººæœªå›æ‡‰ SCTP InitChunk â†’ data channel ç„¡æ³•é–‹å•Ÿ
```

**æ¡æ‰‹é€²åº¦ç¢ºèª**ï¼š

| éšæ®µ | ç‹€æ…‹ | è§€å¯Ÿ |
|------|------|------|
| **SDP äº¤æ›** | âœ… æ­£å¸¸ | HTTP åŠ å¯†é€šè¨ŠæˆåŠŸï¼Œæ©Ÿå™¨äººæ”¶åˆ° Offer ä¸¦å›æ‡‰ Answer |
| **ICE é€£ç·š** | âœ… æ­£å¸¸ | Candidates äº¤æ›æˆåŠŸï¼Œconnection state: completedï¼ŒUDP è·¯å¾‘å¯ç”¨ |
| **DTLS æ¡æ‰‹** | âœ… æ­£å¸¸ | Connection state: connectedï¼ŒSRTP_AES128_CM_SHA1_80 å”å•†å®Œæˆ |
| **SCTP æ¡æ‰‹** | âŒ å¤±æ•— | aiortc ç™¼é€ InitChunkï¼Œæ©Ÿå™¨äººç„¡å›æ‡‰ï¼ŒT1 timeout Ã— 9ï¼Œdata channel ç„¡æ³•é–‹å•Ÿ |

**æ ¹æœ¬åŸå› æ¨è«–**ï¼š
æ¡æ‰‹æµç¨‹å¡åœ¨ Phase 4ï¼ˆSCTP å”è­°å±¤ï¼‰ï¼Œæ©Ÿå™¨äººç«¯æœªå›æ‡‰ SCTP InitChunkã€‚å¯èƒ½çš„åŸå› åŒ…æ‹¬ï¼š
1. Go2 éŸŒé«”çš„ WebRTC å¯¦ç¾é™åˆ¶ï¼ˆSCTP ä¸æ”¯æ´æˆ–è¢«ç¦ç”¨ï¼‰
2. WSL2 ç’°å¢ƒä¸­çš„ SCTP/NAT è¡Œç‚ºç•°å¸¸
3. aiortc/libusrsctp ç‰ˆæœ¬èˆ‡ Go2 å¯¦ä½œä¸ç›¸å®¹
4. go2 å°ˆç”¨çš„ aioice åˆ†æ”¯ï¼ˆexternal_lib/aioice@go2ï¼‰åœ¨ WSL2 ç’°å¢ƒä¸‹è¡¨ç¾ç•°å¸¸

**å·²å®Œæˆçš„è¨ºæ–·æ”¹é€²**ï¼š
- âœ… ç’°å¢ƒæ¸…ç†ï¼ˆæ¸…é™¤å­¤ç«‹é€²ç¨‹ã€ROS daemon é‡å•Ÿï¼‰â†’ ç„¡æ”¹å–„
- âœ… å•Ÿç”¨ DEBUG ç´šæ—¥èªŒ â†’ ç¾åœ¨èƒ½çœ‹åˆ°æ¡æ‰‹è©³æƒ…
  - ä¿®æ”¹æª”æ¡ˆï¼š[go2_driver_node.py:31-36](go2_robot_sdk/go2_robot_sdk/presentation/go2_driver_node.py#L31-L36)
  - è®Šæ›´ï¼šlogging.basicConfig(level=logging.DEBUG)
  - çµæœï¼šæ­ç¤ºäº† SCTP InitChunk timeout Ã— 9 çš„ç—‡ç‹€

- âœ… æ·»åŠ  STUN ä¼ºæœå™¨é…ç½®
  - ä¿®æ”¹æª”æ¡ˆï¼š[go2_connection.py:46-53](go2_robot_sdk/go2_robot_sdk/infrastructure/webrtc/go2_connection.py#L46-L53)
  - è®Šæ›´ï¼šRTCConfiguration + Google STUN servers
  - çµæœï¼šICE/DTLS é€£ç·šå·²æ­£å¸¸å»ºç«‹ï¼Œä½† SCTP æ¡æ‰‹ä»å¤±æ•—

- âœ… æ·»åŠ  SCTP æ¡æ‰‹ç›£æ§
  - ä¿®æ”¹æª”æ¡ˆï¼š[go2_connection.py:110-112, 382-425](go2_robot_sdk/go2_robot_sdk/infrastructure/webrtc/go2_connection.py#L382-L425)
  - æ–°å¢ï¼š`on_data_channel_created()` äº‹ä»¶ç›£è½ã€`_monitor_sctp_handshake()` æ–¹æ³•
  - çµæœï¼š30 ç§’è¶…æ™‚æ™‚è¼¸å‡ºè©³ç´°è¨ºæ–·ï¼ˆdata channel stateã€connection stateã€ICE stateï¼‰

## ğŸ‰ WebRTC é€£æ¥å•é¡Œ - æ ¹æœ¬åŸå› å·²ç¢ºèªä¸¦ä¿®å¾©ï¼

**æœ€çµ‚è¨ºæ–·**ï¼š
å•é¡Œä¸åœ¨ Go2 å›ºä»¶æˆ– WSL2 ç’°å¢ƒï¼Œè€Œæ˜¯ **aiortc ç‰ˆæœ¬ä¸åŒ¹é… + STUN é…ç½®è¡çª**ã€‚

### ç‰ˆæœ¬å·®ç•°å°è‡´å•é¡Œ

| é …ç›® | å¤±æ•—ç’°å¢ƒ | æˆåŠŸç’°å¢ƒ |
|------|---------|---------|
| aiortc | **1.14.0**ï¼ˆå¯¦éš›å®‰è£ï¼‰ | **1.9.0**ï¼ˆrequirements æŒ‡å®šï¼‰ |
| STUN é…ç½® | **æœ‰ï¼ˆRTCConfigurationï¼‰** | **ç„¡ï¼ˆé è¨­ RTCPeerConnectionï¼‰** |
| SCTP æ¡æ‰‹ | InitChunk timeout Ã— 9ï¼ˆ30+ ç§’ï¼‰ | **æˆåŠŸï¼ˆ0.5 ç§’ï¼‰** |
| Data channel | closed | **open** |

### ä¿®å¾©æ­¥é©Ÿ

1. **é™ç´š aiortc åˆ° 1.9.0**
   ```bash
   pip install aiortc==1.9.0
   ```

2. **ç§»é™¤ STUN é…ç½®**
   - è®Šæ›´ï¼š`RTCPeerConnection()` è€Œé `RTCPeerConnection(configuration=RTCConfiguration(...))`
   - åŸå› ï¼šåœ¨åŒä¸€ LANï¼ˆ192.168.x.x â†” 192.168.x.xï¼‰å†…ï¼ŒSTUN éå¿…éœ€ï¼›æŸäº›ç‰ˆæœ¬çš„ aiortc åœ¨ STUN æ™‚æœ‰ SCTP ç›¸å®¹æ€§å•é¡Œ

### é©—è­‰çµæœ

âœ… **é€£æ¥æˆåŠŸ**ï¼šRobot validation successful
âœ… **Data channel é–‹å•Ÿ**ï¼šSCTP æ¡æ‰‹åœ¨ 0.5 ç§’å®Œæˆ
âœ… **å‘½ä»¤åŸ·è¡Œ**ï¼šStand æŒ‡ä»¤æ¸¬è©¦
  - Body height: 0.313 m (lie) â†’ 0.326 m (stand) âœ“
  - Error code: 100 â†’ 1002 (standing mode) âœ“
âœ… **æ„Ÿæ¸¬å™¨æ•¸æ“šæµ**ï¼šæŒçºŒæ¥æ”¶ sportmodestateã€robot_pose ç­‰è³‡æ–™

### é—œéµç™¼ç¾

ã€Œä¹‹å‰æˆåŠŸé€£æ¥ã€çš„ç’°å¢ƒå¾ˆå¯èƒ½å°±æ˜¯ç”¨ aiortc 1.9.0 ä¸”æ²’æœ‰ STUN é…ç½®ã€‚
æœ¬æ¬¡å¤±æ•—æ˜¯å› ç‚ºï¼š
- pip å®‰è£ä¾è³´æ™‚è‡ªå‹•å‡ç´š aiortc åˆ° 1.14.0ï¼ˆå¯èƒ½ä¾†è‡ª torch/torchvision çš„é–“æ¥ä¾è³´ï¼‰
- æˆ‘å€‘æ·»åŠ çš„ STUN é…ç½®åœ¨æ–°ç‰ˆ aiortc ä¸­æœ‰ç›¸å®¹æ€§å•é¡Œ
- Go2 å›ºä»¶æœ¬èº«æ²’æœ‰å•é¡Œï¼Œåªæ˜¯ç‰ˆæœ¬é…åˆä¸å½“

**å»ºè­°çš„å¾ŒçºŒè¡Œå‹•**ï¼ˆå„ªå…ˆé †åºï¼‰**ï¼š

1. **ç¢ºèª Go2 éŸŒé«”ç‰ˆæœ¬**ï¼ˆâ­â­â­â­â­ï¼‰
   - ç›®çš„ï¼šç¸®å° root cause ç¯„åœï¼ˆå›ºä»¶é™åˆ¶ vs. ç’°å¢ƒå•é¡Œï¼‰
   - æ“ä½œï¼šé€éæ‰‹æ©Ÿ App / Web ç•Œé¢æŸ¥è©¢æ©Ÿå™¨äººç•¶å‰éŸŒé«”ç‰ˆæœ¬
   - å¾ŒçºŒï¼šæª¢æŸ¥ RoboVerse Issues/Discussions ä¸­æ˜¯å¦æœ‰è©²ç‰ˆæœ¬çš„ SCTP/WebRTC ç›¸é—œå•é¡Œ

2. **åœ¨åŸç”Ÿ Linux ç’°å¢ƒæ¸¬è©¦**ï¼ˆâ­â­â­â­ï¼‰
   - ç›®çš„ï¼šæ’é™¤ WSL2 SCTP/NAT é™åˆ¶çš„å½±éŸ¿
   - æ“ä½œï¼šåœ¨é WSL2 çš„ Ubuntu è™›æ“¬æ©Ÿä¸ŠåŸ·è¡ŒåŒä¸€é©…å‹•ï¼Œè¨˜éŒ„æ¡æ‰‹éç¨‹
   - é æœŸï¼šè‹¥åŸç”Ÿ Linux ä¹Ÿå¤±æ•—ï¼Œå•é¡Œæ›´å¯èƒ½æ˜¯å›ºä»¶ç›¸é—œï¼›è‹¥æˆåŠŸï¼Œå‰‡æ˜¯ WSL2 ç›¸é—œ

3. **æª¢æŸ¥ aioice@go2 å­æ¨¡çµ„**ï¼ˆâ­â­â­ï¼‰
   - ç›®çš„ï¼šç¢ºèªæ˜¯å¦æœ‰ WSL2/NAT ç›¸é—œä¿®è£œ
   - æ“ä½œï¼š
     ```bash
     cd go2_robot_sdk/external_lib/aioice
     git log --oneline | head -20
     git show <commit> | grep -i "wsl\|nat\|sctp"
     ```
   - è£œå……ï¼šå°æ¯”ä¸Šæ¸¸ aioice/aioiceï¼Œçœ‹æ˜¯å¦æœ‰åˆ†åŒ–

4. **å˜—è©¦å®Œæ•´ workspace é‡å»º**ï¼ˆâ­â­â­ï¼‰
   - ç›®çš„ï¼šæ’é™¤ç·¨è­¯ç·©å­˜/ç‰ˆæœ¬è¡çª
   - æ“ä½œï¼š
     ```bash
     rm -rf build/ install/ log/
     colcon build --packages-select go2_robot_sdk --cmake-force-configure
     ```

5. **è€ƒæ…®å‚™ç”¨æ–¹æ¡ˆ**ï¼ˆâ­â­ï¼‰
   - ç›´æ¥ä½¿ç”¨ Go2 HTTP REST API è€Œé WebRTCï¼ˆå¦‚æœæœ‰å…¬é–‹æ–‡ä»¶ï¼‰
   - æˆ–è¯çµ¡ Unitree/RoboVerse ç¤¾ç¾¤å–å¾—æ©Ÿå™¨äººç«¯ WebRTC æ—¥èªŒ

### 4. è‹¥ä»æœ‰ç’°å¢ƒç•°å¸¸ï¼šè€ƒæ…®é€²è¡Œ workspace å¤§æƒé™¤ï¼ˆå¯é¸ï¼‰

- è‹¥ä¸Šè¿°ç²¾æº–ä¿®è£œå¾Œä»æœ‰é›£ä»¥è¿½è¹¤çš„éŒ¯èª¤ï¼Œå¯æ¡ç”¨è¼ƒæ¿€é€²æ–¹æ¡ˆï¼š
  ```bash
  cd ~/ros2_ws
  rm -rf build/ install/ log/
  rosdep install --from-paths src --ignore-src -r -y
  colcon build --symlink-install
  ```
- å†ä¾ç…§æ¨™æº–æµç¨‹ source èˆ‡å•Ÿå‹•ï¼Œç¢ºä¿æ•´å€‹ workspace ä¹¾æ·¨ä¸€è‡´ã€‚

### 5. è¦åŠƒå¾å·¡é‚ç¯€é»èµ°å‘æœå°‹ FSM

- åœ¨ `docs/02-design/search_fsm_design.md` çš„åŸºç¤ä¸Šï¼Œé–‹å§‹è¦åŠƒï¼š
  - å¦‚ä½•å¾ `SimplePatrolNode` é‡æ§‹/æ“´å……ç‚º `SearchFSMNode`ï¼š
    - æ–°å¢ç‹€æ…‹ï¼šSCANNING / NAVIGATING_TO_OBJECT / APPROACHING / SUCCESS / FAILEDã€‚
    - æ–°å¢è¨‚é–±ï¼š`/detected_objects`ï¼ˆVLM çµæœï¼‰ã€`/object_pose_world`ï¼ˆåº§æ¨™è½‰æ›çµæœï¼‰ã€‚
  - æ¢è¨å“ªäº›é‚è¼¯å¯ä»¥ç›´æ¥é‡ç”¨æ—¢æœ‰ `nav2_client.py` èˆ‡å·¡é‚é‚è¼¯ï¼Œå“ªäº›éœ€è¦æŠ½è±¡ç‚ºå…±ç”¨å…ƒä»¶ã€‚
- ç›®æ¨™ï¼šåœ¨æ–¹æ¡ˆ A ç©©å®šçš„å‰æä¸‹ï¼Œè‡ªç„¶åœ°éæ¸¡åˆ° W6â€“W9 è¦åŠƒä¸­çš„å®Œæ•´å°‹ç‰©ç³»çµ±ã€‚
